<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Lemonade front-end</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css">

    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="./script/web3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
    <script language="javascript" type="text/javascript" src="./abi/lemonade_abi.js"></script>
</head>

<body>
    <div id="balance"></div>
    <div id="mylemonades"></div>


    <!--Script to interact with smartcontract-->
    <script>
        window.addEventListener('load', function () {
            // Check if Web3 has been injected by the browser:
            if (typeof web3 !== 'undefined') {
                // You have a web3 browser! Continue below!
                startApp(web3);
                //alert("Web3");
            } else {
                //alert("No hay web3");
                // Warn the user that they need to get a web3 browser
                // Or install MetaMask, maybe with a nice graphic.
            }
        })
        const abi = lemonadeABI;
        const contract_address = '0x44747b9caa0b57799c9cac15b46be3da6a1df9de'
        var userAccount = 'userAccount';
        var refAccount = 'refAccount';
        var _gas = 50;
        
        function startApp(web3) {
            //alert("entro");
            const eth = new Eth(web3.currentProvider);
            const token = eth.contract(abi).at(contract_address);
            listenForClicks(token, web3);
        }

        function listenForClicks(lemonadeStand, web3) {
            var button = document.querySelector('button.transferFunds');

            var accountInterval = setInterval(function () {
                web3.eth.getAccounts(function (err, accounts) { userAccount = accounts[0]; });
                if (refAccount !== userAccount) {
                    console.log("na: " + nAccount);
                    console.log("ua: " + userAccount);
                    if (userAccount.length > 12) { getLemonadesByOwner(userAccount) };
                    //.then(displayMyLemonades);
                }
            }, 300);

            function displayMyLemonades(ids) {
                $("#mylemonades").empty();
                for (id of ids) {
                    // Look up lemonade details from our contract. Returns a `lemonade` object
                    lemonadeStand.lemonades(id)
                        .then(function (lemonade) {
                            $("#mylemonades").append(`<div class="lemonade">
                            <ul>
                                <li>Name: ${lemonade.name}</li>
                                <li>Ingredients: ${lemonade.ingredients}</li>
                                <li>onsumed: ${lemonade.consumed}</li>
                            </ul>
                            </div>`);
                        });
                }
            }

            function getLemonadeDetails(id) {
                lemonadeStand.lemonades(id).then(function (id) {
                    return id;
                });
            }

            function lemonadeToOwner(id) {
                return lemonadeStand.lemonadeToOwner(id);
            }

            function getNumberOfLemonades() {
                lemonadeStand.size().then(function (count) {
                    return count[0];
                });
            }

            function getLemonadesByOwner(owner) {
                lemonadeStand.getLemonadesByOwner(owner).then(function (ids) {
                    refAccount = userAccount; //Make sure they are the same
                    getbalanceOfLemonadeCoins(owner);
                    displayMyLemonades(ids[0]);
                });
            }

            function getbalanceOfLemonadeCoins(owner) {
                lemonadeStand.balanceOf(owner).then(function(balance){
                    $("#balance").empty();
                    $("#balance").text("LemonadeCoin(LMC) balance: " + balance[0]);
                });
            }
        }//listenForClicks

        //When you send ether to performe some actions, wait for it to be mined. Success/Fail
        async function waitForTxToBeMined(txHash) {
            let txReceipt
            while (!txReceipt) {
                try {
                    txReceipt = await eth.getTransactionReceipt(txHash)
                } catch (err) {
                    return indicateFailure(err)
                }
            }
            indicateSuccess()
        }
    </script>
</body>

</html>